<!DOCTYPE html>
<html>
  <head>
    <title>cannon.js - stacks demo</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="css/style.css" type="text/css" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  </head>
  <body>
    <script type="module">
      import * as CANNON from '../dist/cannon-es.js'
      import { Demo } from './js/Demo.js'

      /**
       * For debugging different kinds of stacks
       */
      const demo = new Demo()
      const size = 2,
        mass = 5

      function createTetra() {
        const vertices = [
          new CANNON.Vec3(0, 0, 0),
          new CANNON.Vec3(2, 0, 0),
          new CANNON.Vec3(0, 2, 0),
          new CANNON.Vec3(0, 0, 2),
        ]
        const offset = -0.35
        for (let i = 0; i < vertices.length; i++) {
          const v = vertices[i]
          v.x += offset
          v.y += offset
          v.z += offset
        }
        return new CANNON.ConvexPolyhedron({
          vertices: vertices,
          faces: [
            [0, 3, 2], // -x
            [0, 1, 3], // -y
            [0, 2, 1], // -z
            [1, 2, 3], // +xyz
          ],
        })
      }
      function createBoxPolyhedron(size) {
        size = size || 1
        const box = new CANNON.Box(new CANNON.Vec3(size, size, size))
        return box.convexPolyhedronRepresentation
      }

      function createCompound(mass) {
        const compoundBody = new CANNON.Body({ mass: mass })
        const s = size
        const shape = new CANNON.Box(new CANNON.Vec3(0.5 * s, 0.5 * s, 0.5 * s))
        compoundBody.addShape(shape, new CANNON.Vec3(0, 0, s))
        compoundBody.addShape(shape, new CANNON.Vec3(0, 0, 0))
        compoundBody.addShape(shape, new CANNON.Vec3(0, 0, -s))
        compoundBody.addShape(shape, new CANNON.Vec3(-s, 0, -s))
        return compoundBody
      }

      // Spheres
      demo.addScene('sphere/sphere', () => {
        const world = setupWorld(demo)

        // Sphere 1
        const sphereShape = new CANNON.Sphere(size)
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(sphereShape)
        b1.position.set(0, 0, 3 * size)
        world.addBody(b1)
        demo.addVisual(b1)

        // Sphere 2
        const b2 = new CANNON.Body({ mass: 5 })
        b2.addShape(sphereShape)
        b2.position.set(0, 0, 1 * size)
        world.addBody(b2)
        demo.addVisual(b2)
      })

      // Sphere/plane
      demo.addScene('sphere/plane', () => {
        const world = setupWorld(demo)

        // Sphere 1
        const sphereShape = new CANNON.Sphere(size)
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(sphereShape)
        b1.position.set(0, 0, 3 * size)
        world.addBody(b1)
        demo.addVisual(b1)
      })

      // Sphere / box side
      demo.addScene('sphere/box', () => {
        const world = setupWorld(demo)

        const boxShape = new CANNON.Box(new CANNON.Vec3(size, size, size))
        const sphereShape = new CANNON.Sphere(size)

        // Box
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(boxShape)
        b1.position.set(0, 0, 1 * size)
        world.addBody(b1)
        demo.addVisual(b1)

        // Sphere
        const b2 = new CANNON.Body({ mass: 5 })
        b2.addShape(sphereShape)
        b2.position.set(0, 0, 3 * size)
        world.addBody(b2)
        demo.addVisual(b2)
      })

      demo.addScene('sphere/compound', () => {
        const world = setupWorld(demo)

        // Sphere
        const sphereShape = new CANNON.Sphere(size * 0.5)
        const b = new CANNON.Body({ mass: 5 })
        b.addShape(sphereShape)
        b.position.set(-size, 0, 6 * size)
        world.addBody(b)
        demo.addVisual(b)

        const compoundBody = createCompound(mass)
        compoundBody.position.set(0, 0, size * 3)
        world.addBody(compoundBody)
        demo.addVisual(compoundBody)
      })

      demo.addScene('sphere/convex', () => {
        const world = setupWorld(demo)

        // Sphere
        const sphereShape = new CANNON.Sphere(size * 0.5)
        const b = new CANNON.Body({ mass: 5 })
        b.addShape(sphereShape)
        b.position.set(0, 0, 6 * size)
        world.addBody(b)
        demo.addVisual(b)

        const shape = createTetra() //createBoxPolyhedron(size);
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(shape)
        b1.position.set(0, 0, 1 * size)
        world.addBody(b1)
        demo.addVisual(b1)
      })

      demo.addScene('sphere/particle', () => {
        const world = setupWorld(demo)

        // Sphere
        const sphereShape = new CANNON.Sphere(size * 0.5)
        const b = new CANNON.Body({ mass: 5 })
        b.addShape(sphereShape)
        b.position.set(0, 0, size)
        world.addBody(b)
        demo.addVisual(b)

        // Particle
        const p = new CANNON.Body({ mass: 1 })
        p.addShape(new CANNON.Particle())
        p.position.set(0.02, 0, 3 * size)

        world.addBody(p)
        demo.addVisual(p)
      })

      demo.addScene('plane/box', () => {
        const world = setupWorld(demo)
        const boxShape = new CANNON.Box(new CANNON.Vec3(size, size, size))
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(boxShape)
        b1.position.set(0, 0, 1 * size)
        world.addBody(b1)
        demo.addVisual(b1)
      })

      demo.addScene('plane/compound', () => {
        const world = setupWorld(demo)
        const b1 = createCompound(5)
        b1.position.set(0, 0, 4 * size)
        world.addBody(b1)
        demo.addVisual(b1)
      })

      demo.addScene('plane/convex', () => {
        const world = setupWorld(demo)
        const shape = createTetra()
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(shape)
        b1.position.set(0, 0, 1 * size)
        world.addBody(b1)
        demo.addVisual(b1)
      })

      demo.addScene('plane/particle', () => {
        const world = setupWorld(demo)
        // Particle
        const p = new CANNON.Body({ mass: 1 })
        p.addShape(new CANNON.Particle())
        p.position.set(0.02, 0, 3 * size)
        world.addBody(p)
        demo.addVisual(p)
      })

      // Boxes
      demo.addScene('box/box', () => {
        const world = setupWorld(demo)

        // Box 1
        const boxShape = new CANNON.Box(new CANNON.Vec3(size * 0.5, size * 0.5, size * 0.5))
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(boxShape)
        b1.position.set(0, 0, 1 * size)
        world.addBody(b1)
        demo.addVisual(b1)

        // Box 2
        const b2 = new CANNON.Body({ mass: 5 })
        b2.addShape(boxShape)
        b2.position.set(size * 0.5, 0, 3 * size)
        world.addBody(b2)
        demo.addVisual(b2)
      })

      demo.addScene('box/compound', () => {
        const world = setupWorld(demo)

        const b2 = createCompound(5)
        b2.position.set(size * 0.5, 0, 2 * size)
        world.addBody(b2)
        demo.addVisual(b2)

        const boxShape = new CANNON.Box(new CANNON.Vec3(size * 0.5, size * 0.5, size * 0.5))
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(boxShape)
        b1.position.set(0, 0, 7 * size)
        world.addBody(b1)
        demo.addVisual(b1)
      })

      demo.addScene('box/convex', () => {
        const world = setupWorld(demo)

        const shape = createTetra(size)
        const b2 = new CANNON.Body({ mass: 5 })
        b2.addShape(shape)
        b2.position.set(0, 0, 5 * size)
        world.addBody(b2)
        demo.addVisual(b2)

        const boxShape = new CANNON.Box(new CANNON.Vec3(size * 0.5, size * 0.5, size * 0.5))
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(boxShape)
        b1.position.set(0, 0, 2 * size)
        world.addBody(b1)
        demo.addVisual(b1)
      })

      demo.addScene('box/particle', () => {
        const world = setupWorld(demo)

        const boxShape = new CANNON.Box(new CANNON.Vec3(size * 0.5, size * 0.5, size * 0.5))
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(boxShape)
        b1.position.set(0, 0, 1 * size)
        world.addBody(b1)
        demo.addVisual(b1)

        // Particle
        const p = new CANNON.Body({ mass: 1 })
        p.addShape(new CANNON.Particle())
        p.position.set(0, 0, 3 * size)
        world.addBody(p)
        demo.addVisual(p)
      })

      demo.addScene('compound/compound', () => {
        const world = setupWorld(demo)

        const b2 = createCompound(5)
        b2.position.set(size * 0.5, 0, 6 * size)
        world.addBody(b2)
        demo.addVisual(b2)

        const b2 = createCompound(5)
        b2.position.set(size * 0.5, 0, 2 * size)
        world.addBody(b2)
        demo.addVisual(b2)
      })

      demo.addScene('compound/convex', () => {
        const world = setupWorld(demo)

        const tetraShape = createTetra()

        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(tetraShape)
        b1.position.set(0, 0, 3 * size)
        world.addBody(b1)
        demo.addVisual(b1)

        // Box 2
        const boxShape = new CANNON.Box(new CANNON.Vec3(size * 0.5, size * 0.5, size * 0.5))
        const b2 = new CANNON.Body({ mass: 5 })
        b2.addShape(boxShape)
        b2.position.set(0, 0, 1 * size)
        world.addBody(b2)
        demo.addVisual(b2)
      })

      demo.addScene('compound/particle', () => {
        const world = setupWorld(demo)

        const t = createCompound(5)
        t.position.set(0, 0, 4 * size)

        // Particle
        const p = new CANNON.Body({ mass: 1 })
        p.addShape(new CANNON.Particle())
        p.position.set(0, 0, 7 * size)
        world.addBody(t)
        demo.addVisual(t)
        world.addBody(p)
        demo.addVisual(p)
      })

      // ConvexPolyhedron and box
      demo.addScene('convex/convex', () => {
        const world = setupWorld(demo)

        const tetraShape = createTetra()
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(tetraShape)
        b1.position.set(0.1, 0.1, 5 * size)
        world.addBody(b1)
        demo.addVisual(b1)

        const tetraShape = createTetra()
        const b1 = new CANNON.Body({ mass: 5 })
        b1.addShape(tetraShape)
        b1.position.set(0, 0, 3 * size)
        world.addBody(b1)
        demo.addVisual(b1)
      })

      // ConvexPolyhedron and particle
      demo.addScene('convex/particle', () => {
        const world = setupWorld(demo)

        const tetraShape = createBoxPolyhedron(size)
        const t = new CANNON.Body({ mass: 5 })
        t.addShape(tetraShape)
        t.position.set(0, 0, 1 * size)
        t.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), Math.PI / 2)

        // Particle
        const p = new CANNON.Body({ mass: 1 })
        p.addShape(new CANNON.Particle())
        p.position.set(0, 0, 3 * size)

        world.addBody(t)
        demo.addVisual(t)
        world.addBody(p)
        demo.addVisual(p)
      })

      demo.start()

      function setupWorld(demo) {
        const world = demo.getWorld()
        world.gravity.set(0, 0, -10)
        world.broadphase = new CANNON.NaiveBroadphase()
        world.solver.iterations = 20

        world.defaultContactMaterial.contactEquationStiffness = 1e7
        world.defaultContactMaterial.contactEquationRelaxation = 5

        // ground plane
        const groundShape = new CANNON.Plane()
        const groundBody = new CANNON.Body({ mass: 0 })
        groundBody.addShape(groundShape)
        groundBody.position.set(0, 0, -1)
        //groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0),0.2);
        world.addBody(groundBody)
        demo.addVisual(groundBody)
        return world
      }
    </script>
  </body>
</html>
